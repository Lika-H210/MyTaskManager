<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.portfolio.taskapp.MyTaskManager.user.repository.UserRepository">

  <!-- ログイン検証用情報の取得 -->
  <select id="findAccountByEmail"
    parameterType="String"
    resultType="com.portfolio.taskapp.MyTaskManager.domain.entity.UserAccount">
    SELECT id, public_id, email, password
    FROM user_accounts
    WHERE email =#{email} AND is_deleted = false
  </select>

  <!-- アカウント情報の取得（パスワードは含まない） -->
  <select id="findAccountByPublicId" parameterType="String"
    resultType="com.portfolio.taskapp.MyTaskManager.domain.entity.UserAccount">
    SELECT public_id, user_name, email, created_at, updated_at
    FROM user_accounts
    WHERE public_id = #{publicId} AND is_deleted = false
  </select>

  <!-- ユーザーアカウントの登録 -->
  <insert id="registerUserAccount"
    parameterType="com.portfolio.taskapp.MyTaskManager.domain.entity.UserAccount"
    keyProperty="id" useGeneratedKeys="true">
    INSERT INTO user_accounts (public_id, user_name, email, password, is_deleted)
    VALUES (#{publicId}, #{userName}, #{email}, #{password}, false)
  </insert>

  <!-- ユーザーアカウントの更新 -->
  <update id="updateAccount"
    parameterType="com.portfolio.taskapp.MyTaskManager.domain.entity.UserAccount">
    UPDATE user_accounts
    <set>
      <if test="userName != null">
        user_name = #{userName},
      </if>
      <if test="email != null">
        email = #{email},
      </if>
      <if test="password != null">
        password = #{password}
      </if>
    </set>
    WHERE public_id = #{publicId}
    AND is_deleted = false
  </update>

  <!-- アカウントの論理削除-->
  <update id="deleteAccount"
    parameterType="String">
    UPDATE user_accounts
    SET
    is_deleted = true
    WHERE public_id = #{publicId}
    AND is_deleted = false
  </update>

  <!--Email重複チェック　※DBにemailと同じemailが存在する場合True-->
  <select id="existsByEmail" parameterType="String" resultType="boolean">
    SELECT COUNT(*) > 0
    FROM user_accounts
    WHERE email = #{email}
  </select>

</mapper>
