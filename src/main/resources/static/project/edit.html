<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>プロジェクト詳細／編集</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet">
  <link href="../css/style.css" rel="stylesheet">
</head>

<body class="container my-4">
<div class="form-wrapper">
  <h3 class="mb-3">プロジェクト詳細／編集</h3>
  <form id="project-form">

    <div class="mb-3">
      <label for="project-caption" class="form-label">
        プロジェクト名<span class="required">必須</span>
      </label>
      <input type="text" class="form-control full-width-input" id="project-caption"
             name="projectCaption" required maxlength="100" pattern=".*\S.*">
    </div>

    <div class="mb-3">
      <label for="description" class="form-label">詳細説明</label>
      <textarea class="form-control full-width-input" id="description" name="description"
                rows="5" maxlength="1000"></textarea>
    </div>

    <div class="mb-3">
      <label for="status" class="form-label">ステータス</label>
      <select class="form-select w-auto" id="status">
        <option value="ACTIVE">ACTIVE</option>
        <option value="ARCHIVED">ARCHIVED</option>
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">作成日時</label>
      <span id="created-at"></span>
    </div>

    <div class="mb-3">
      <label class="form-label">更新日時</label>
      <span id="updated-at"></span>
    </div>

    <button type="submit" class="btn btn-success">更新</button>
    <button type="button" class="btn btn-secondary" id="back-button">戻る</button>
  </form>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const projectPublicId = params.get("projectPublicId");

  fetch(`/projects/${projectPublicId}`)
    .then(res => res.json())
    .then(project => {
      document.getElementById('project-caption').value = project.projectCaption;
      document.getElementById('description').value = project.description;
      document.getElementById('status').value = project.status;
      document.getElementById('created-at').innerText = project.createdAt;
      document.getElementById('updated-at').innerText = project.updatedAt;
    })
    .catch(err => console.error(err));

  // 更新ボタン
  document.getElementById('project-form').addEventListener('submit', e => {
    e.preventDefault();

    const requestBody = {
      projectCaption: document.getElementById('project-caption').value,
      description: document.getElementById('description').value,
      status: document.getElementById('status').value
    };

    fetch(`/projects/${projectPublicId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestBody)
    })
      .then(res => {
        if (res.ok) {
          window.location.href = `/project/list.html`;
        } else {
          return res.json().then(err => { throw err; });
        }
      })
      .catch(err => {
        console.error(err);
        alert('更新に失敗しました');
        window.location.href = `/project/list.html`;
      });
  });

  // 戻るボタン
  document.getElementById('back-button').addEventListener('click', () => {
    window.location.href = `/project/list.html?projectPublicId=${projectPublicId}`;
  });
</script>
</body>
</html>