<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link href="../css/style.css" rel="stylesheet" />
  </head>

  <body class="container my-4">
    <div class="form-wrapper">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß</h1>

        <div class="d-flex gap-2">
          <a href="/user/account.html" class="btn btn-outline-secondary">
            <i class="bi bi-person-circle"></i> „Ç¢„Ç´„Ç¶„É≥„Éà
          </a>
          <button id="logout-btn" class="btn btn-outline-danger">
            <i class="bi bi-box-arrow-right"></i> „É≠„Ç∞„Ç¢„Ç¶„Éà
          </button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle">
          <thead class="table-primary">
            <tr>
              <th>„Éó„É≠„Ç∏„Çß„ÇØ„Éà</th>
              <th class="col-with-min-fixed">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
              <th class="col-with-min-fixed">„Çø„Çπ„ÇØ‰∏ÄË¶ß</th>
              <th class="col-with-min-fixed">Á∑®ÈõÜ</th>
              <th class="col-with-min-fixed">ÂâäÈô§</th>
            </tr>
          </thead>
          <tbody id="project-body">
            <!-- JS„Åß„Éá„Éº„ÇøË°å„ÇíÊåøÂÖ• -->
          </tbody>
        </table>
      </div>

      <button id="create-project-btn" class="btn btn-primary">
        „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁôªÈå≤
      </button>
    </div>

    <script>
      // token„ÅÆÂèñÂæó
      let csrfToken = null;

      async function getCsrfToken() {
        if (csrfToken) return csrfToken; // Êó¢„Å´ÂèñÂæóÊ∏à„Åø„Å™„ÇâÂÜçÂà©Áî®

        try {
          const res = await fetch("/csrf-token", { credentials: "include" });
          if (!res.ok) throw new Error("CSRF„Éà„Éº„ÇØ„É≥„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");

          const data = await res.json();
          if (!data.token)
            throw new Error("CSRF„Éà„Éº„ÇØ„É≥„Åå„É¨„Çπ„Éù„É≥„Çπ„Å´Â≠òÂú®„Åó„Åæ„Åõ„Çì");

          csrfToken = data.token;
          return csrfToken;
        } catch (err) {
          console.error("CSRFÂèñÂæó„Ç®„É©„Éº:", err);
          alert("ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÊìç‰Ωú„Çí„ÇÑ„ÇäÁõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
          throw err; // Âëº„Å≥Âá∫„ÅóÂÖÉ„Åß„ÇÇ try/catch „ÅßÂá¶ÁêÜÂèØËÉΩ
        }
      }

      // „É≠„Ç∞„Ç¢„Ç¶„ÉàÂá¶ÁêÜ
      document
        .getElementById("logout-btn")
        .addEventListener("click", async () => {
          if (!confirm("„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü")) return;

          try {
            const token = await getCsrfToken();

            const res = await fetch("/logout", {
              method: "POST",
              headers: {
                "X-XSRF-TOKEN": token,
              },
              credentials: "include",
            });

            if (!res.ok) {
              alert("„É≠„Ç∞„Ç¢„Ç¶„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
            }

            window.location.href = "/login.html";
          } catch (err) {
            console.error(err);
            alert("ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü");
          }
        });

      document.addEventListener("DOMContentLoaded", async () => {
        try {
          // „Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ßÂèñÂæó
          const res = await fetch("/projects", { credentials: "include" });
          if (!res.ok) throw new Error("„Éó„É≠„Ç∏„Çß„ÇØ„Éà‰∏ÄË¶ß„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
          const data = await res.json();

          const projectBody = document.getElementById("project-body");

          projectBody.innerHTML =
            Array.isArray(data) && data.length > 0
              ? data
                  .map(
                    (p) => `
                    <tr data-public-id="${p.publicId}">
                      <td>${p.projectCaption ?? ""}</td>
                      <td>${p.status ?? ""}</td>
                      <td>
                        <a href="/task/task-tree-list.html?projectPublicId=${
                          p.publicId
                        }">
                          üìÇ
                        </a>
                      </td>
                      <td>
                        <a href="/project/edit.html?projectPublicId=${
                          p.publicId
                        }">
                        üìù
                        </a>
                      </td>
                      <td>
                        <button class="btn btn-link p-0 btn-delete" style="color:red;">
                          ‚ùå
                        </button>
                      </td>
                    </tr>`
                  )
                  .join("")
              : `<tr><td colspan="5">„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</td></tr>`;

          // ÂâäÈô§Âá¶ÁêÜ
          projectBody.querySelectorAll(".btn-delete").forEach((btn) => {
            btn.addEventListener("click", async (e) => {
              const projectRow = e.target.closest("tr");
              const publicId = projectRow.dataset.publicId;
              if (!confirm("„Åì„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) return;

              try {
                const token = await getCsrfToken();
                const res = await fetch(`/projects/${publicId}`, {
                  method: "DELETE",
                  headers: { "X-XSRF-TOKEN": token },
                  credentials: "include",
                });

                if (res.ok) {
                  projectRow.remove();
                } else {
                  alert("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
                }
              } catch (err) {
                console.error(err);
                alert("ÈÄö‰ø°„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü");
              }
            });
          });
        } catch (err) {
          console.error(err);
          alert("„Éö„Éº„Ç∏„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
        }
      });

      // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÁôªÈå≤
      const createProjectBtn = document.getElementById("create-project-btn");
      createProjectBtn.addEventListener("click", () => {
        window.location.href = `/project/create.html`;
      });
    </script>
  </body>
</html>
