<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <title>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§</title>
  <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
  />
  <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
  />
  <link href="../css/style.css" rel="stylesheet"/>
</head>

<body class="container my-4">
<div class="form-wrapper">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§</h1>

    <div class="d-flex gap-2">
      <a href="/user/account.html" class="btn btn-outline-secondary">
        <i class="bi bi-person-circle"></i> ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
      </a>
      <button id="logout-btn" class="btn btn-outline-danger">
        <i class="bi bi-box-arrow-right"></i> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      </button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-bordered align-middle">
      <thead class="table-primary">
      <tr>
        <th>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</th>
        <th class="col-with-min-fixed">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
        <th class="col-with-min-fixed">ã‚¿ã‚¹ã‚¯ä¸€è¦§</th>
        <th class="col-with-min-fixed">ç·¨é›†</th>
        <th class="col-with-min-fixed">å‰Šé™¤</th>
      </tr>
      </thead>
      <tbody id="project-body">
      <!-- JSã§ãƒ‡ãƒ¼ã‚¿è¡Œã‚’æŒ¿å…¥ -->
      </tbody>
    </table>
  </div>

  <button id="create-project-btn" class="btn btn-primary">
    ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç™»éŒ²
  </button>
</div>

<script>
  // tokenã®å–å¾—
  let csrfToken = null;

  async function getCsrfToken() {
    if (csrfToken) return csrfToken; // æ—¢ã«å–å¾—æ¸ˆã¿ãªã‚‰å†åˆ©ç”¨

    try {
      const res = await fetch("/csrf-token", { credentials: "include" });
      if (!res.ok) throw new Error("CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");

      const data = await res.json();
      if (!data.token)
        throw new Error("CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å­˜åœ¨ã—ã¾ã›ã‚“");

      csrfToken = data.token;
      return csrfToken;
    } catch (err) {
      console.error("CSRFå–å¾—ã‚¨ãƒ©ãƒ¼:", err);
      alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ“ä½œã‚’ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚");
      throw err; // å‘¼ã³å‡ºã—å…ƒã§ã‚‚ try/catch ã§å‡¦ç†å¯èƒ½
    }
  }

  // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
  document
    .getElementById("logout-btn")
    .addEventListener("click", async () => {
      if (!confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;

      try {
        const token = await getCsrfToken();

        const res = await fetch("/logout", {
          method: "POST",
          headers: {
            "X-XSRF-TOKEN": token,
          },
          credentials: "include",
        });

        if (!res.ok) {
          alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ");
        }

        window.location.href = "/login.html";
      } catch (err) {
        console.error(err);
        alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      }
    });

  document.addEventListener("DOMContentLoaded", async () => {
    try {
      // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§å–å¾—
      const res = await fetch("/projects", { credentials: "include" });
      if (!res.ok) throw new Error("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
      const data = await res.json();

      const projectBody = document.getElementById("project-body");
      projectBody.innerHTML = "";

      if (Array.isArray(data) && data.length > 0) {
        data.forEach((p) => {
          const tr = document.createElement("tr");
          tr.dataset.publicId = p.publicId;

          // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
          const tdCaption = document.createElement("td");
          tdCaption.textContent = p.projectCaption ?? "";
          tr.appendChild(tdCaption);

          // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
          const tdStatus = document.createElement("td");
          tdStatus.textContent = p.status ?? "";
          tr.appendChild(tdStatus);

          // ã‚¿ã‚¹ã‚¯ä¸€è¦§ãƒªãƒ³ã‚¯
          const tdTask = document.createElement("td");
          const aTask = document.createElement("a");
          aTask.href = `/task/task-tree-list.html?projectPublicId=${encodeURIComponent(p.publicId)}`;
          aTask.textContent = "ðŸ“‚";
          tdTask.appendChild(aTask);
          tr.appendChild(tdTask);

          // ç·¨é›†ãƒªãƒ³ã‚¯
          const tdEdit = document.createElement("td");
          const aEdit = document.createElement("a");
          aEdit.href = `/project/edit.html?projectPublicId=${encodeURIComponent(p.publicId)}`;
          aEdit.textContent = "ðŸ“";
          tdEdit.appendChild(aEdit);
          tr.appendChild(tdEdit);

          // å‰Šé™¤ãƒœã‚¿ãƒ³
          const tdDelete = document.createElement("td");
          const btnDelete = document.createElement("button");
          btnDelete.className = "btn btn-link p-0 btn-delete";
          btnDelete.style.color = "red";
          btnDelete.textContent = "âŒ";
          tdDelete.appendChild(btnDelete);
          tr.appendChild(tdDelete);

          projectBody.appendChild(tr);

          // å‰Šé™¤å‡¦ç†
          btnDelete.addEventListener("click", async (e) => {
            if (!confirm("ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

            try {
              const token = await getCsrfToken();
              const res = await fetch(`/projects/${p.publicId}`, {
                method: "DELETE",
                headers: { "X-XSRF-TOKEN": token },
                credentials: "include",
              });

              if (res.ok) {
                tr.remove();
              } else {
                alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
              }
            } catch (err) {
              console.error(err);
              alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            }
          });
        });
      }
    } catch (err) {
      console.error(err);
      alert("ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  });

  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç™»éŒ²
  const createProjectBtn = document.getElementById("create-project-btn");
  createProjectBtn.addEventListener("click", () => {
    window.location.href = `/project/create.html`;
  });
</script>
</body>
</html>
