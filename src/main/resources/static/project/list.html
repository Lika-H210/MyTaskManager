<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>プロジェクト一覧</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link href="../css/style.css" rel="stylesheet" />
  </head>

  <body class="container my-4">
    <div class="form-wrapper">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">プロジェクト一覧</h1>

        <div class="d-flex gap-2">
          <a href="/user/account.html" class="btn btn-outline-secondary">
            <i class="bi bi-person-circle"></i> アカウント
          </a>
          <button id="logout-btn" class="btn btn-outline-danger">
            <i class="bi bi-box-arrow-right"></i> ログアウト
          </button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle">
          <thead class="table-primary">
            <tr>
              <th>プロジェクト</th>
              <th class="col-with-min-fixed">ステータス</th>
              <th class="col-with-min-fixed">タスク一覧</th>
              <th class="col-with-min-fixed">編集</th>
              <th class="col-with-min-fixed">削除</th>
            </tr>
          </thead>
          <tbody id="project-body">
            <!-- JSでデータ行を挿入 -->
          </tbody>
        </table>
      </div>

      <button id="create-project-btn" class="btn btn-primary">
        プロジェクト登録
      </button>
    </div>
    <script>
      // ログアウト
      document
        .getElementById("logout-btn")
        .addEventListener("click", async () => {
          if (!confirm("ログアウトしますか？")) return;

          try {
            const res = await fetch("/logout", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" }, // Spring Security用
            });
            if (res.ok) {
              window.location.href = "/login.html"; // ログアウト後の遷移先（任意に変更）
            } else {
              alert("ログアウトに失敗しました");
            }
          } catch (err) {
            console.error(err);
            alert("通信エラーが発生しました");
          }
        });

      // プロジェクト一覧取得
      fetch("/projects")
        .then((res) => res.json())
        .then((data) => {
          const projectBody = document.getElementById("project-body");

          if (Array.isArray(data) && data.length > 0) {
            projectBody.innerHTML = data
              .map(
                (p) => `
          <tr data-public-id="${p.publicId}">
            <td>${p.projectCaption ?? ""}</td>
            <td>${p.status ?? ""}</td>
            <td>
              <a href="/task/task-tree-list.html?projectPublicId=${p.publicId}"
                 title="タスク一覧">
                📂
              </a>
            </td>
            <td>
              <a href="/project/edit.html?projectPublicId=${p.publicId}"
                 title="プロジェクト詳細/編集">
                📝
              </a>
            </td>
            <td>
              <button class="btn btn-link p-0 btn-delete" title="削除" style="color:red;">
                ❌
              </button>
            </td>
          </tr>
        `
              )
              .join("");

            // 削除ボタン処理
            projectBody.querySelectorAll(".btn-delete").forEach((btn) => {
              btn.addEventListener("click", (e) => {
                const projectRow = e.target.closest("tr");
                const publicId = projectRow.dataset.publicId;
                if (confirm("本当に削除しますか？")) {
                  fetch(`/projects/${publicId}`, { method: "DELETE" })
                    .then((res) => {
                      if (res.ok) {
                        projectRow.remove(); // 行を削除
                      } else {
                        alert("削除に失敗しました");
                      }
                    })
                    .catch((err) => console.error(err));
                }
              });
            });
          } else {
            projectBody.innerHTML = `<tr><td colspan="5">プロジェクトがありません</td></tr>`;
          }
        })
        .catch((err) => {
          console.error(err);
          document.getElementById(
            "project-body"
          ).innerHTML = `<tr><td colspan="5">読み込みに失敗しました</td></tr>`;
        });

      // プロジェクト登録
      const createProjectBtn = document.getElementById("create-project-btn");
      createProjectBtn.addEventListener("click", () => {
        window.location.href = `/project/create.html`;
      });
    </script>
  </body>
</html>
