<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <title>プロジェクト一覧</title>
  <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
  />
  <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
  />
  <link href="../css/style.css" rel="stylesheet"/>
</head>

<body class="container my-4">
<div class="form-wrapper">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">プロジェクト一覧</h1>

    <div class="d-flex gap-2">
      <a href="/user/account.html" class="btn btn-outline-secondary">
        <i class="bi bi-person-circle"></i> アカウント
      </a>
      <button id="logout-btn" class="btn btn-outline-danger">
        <i class="bi bi-box-arrow-right"></i> ログアウト
      </button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-bordered align-middle">
      <thead class="table-primary">
      <tr>
        <th>プロジェクト</th>
        <th class="col-with-min-fixed">ステータス</th>
        <th class="col-with-min-fixed">タスク一覧</th>
        <th class="col-with-min-fixed">編集</th>
        <th class="col-with-min-fixed">削除</th>
      </tr>
      </thead>
      <tbody id="project-body">
      <!-- JSでデータ行を挿入 -->
      </tbody>
    </table>
  </div>

  <button id="create-project-btn" class="btn btn-primary">
    プロジェクト登録
  </button>
</div>

<script>
  // tokenの取得
  let csrfToken = null;

  async function getCsrfToken() {
    if (csrfToken) return csrfToken; // 既に取得済みなら再利用

    try {
      const res = await fetch("/csrf-token", { credentials: "include" });
      if (!res.ok) throw new Error("CSRFトークンの取得に失敗しました");

      const data = await res.json();
      if (!data.token)
        throw new Error("CSRFトークンがレスポンスに存在しません");

      csrfToken = data.token;
      return csrfToken;
    } catch (err) {
      console.error("CSRF取得エラー:", err);
      alert("通信エラーが発生しました。操作をやり直してください。");
      throw err; // 呼び出し元でも try/catch で処理可能
    }
  }

  // ログアウト処理
  document
    .getElementById("logout-btn")
    .addEventListener("click", async () => {
      if (!confirm("ログアウトしますか？")) return;

      try {
        const token = await getCsrfToken();

        const res = await fetch("/logout", {
          method: "POST",
          headers: {
            "X-XSRF-TOKEN": token,
          },
          credentials: "include",
        });

        if (!res.ok) {
          alert("ログアウトに失敗しました");
        }

        window.location.href = "/login.html";
      } catch (err) {
        console.error(err);
        alert("通信エラーが発生しました");
      }
    });

  document.addEventListener("DOMContentLoaded", async () => {
    try {
      // プロジェクト一覧取得
      const res = await fetch("/projects", { credentials: "include" });
      if (!res.ok) throw new Error("プロジェクト一覧の取得に失敗しました");
      const data = await res.json();

      const projectBody = document.getElementById("project-body");
      projectBody.innerHTML = "";

      if (Array.isArray(data) && data.length > 0) {
        data.forEach((p) => {
          const tr = document.createElement("tr");
          tr.dataset.publicId = p.publicId;

          // プロジェクト名
          const tdCaption = document.createElement("td");
          tdCaption.textContent = p.projectCaption ?? "";
          tr.appendChild(tdCaption);

          // ステータス
          const tdStatus = document.createElement("td");
          tdStatus.textContent = p.status ?? "";
          tr.appendChild(tdStatus);

          // タスク一覧リンク
          const tdTask = document.createElement("td");
          const aTask = document.createElement("a");
          aTask.href = `/task/task-tree-list.html?projectPublicId=${encodeURIComponent(p.publicId)}`;
          aTask.textContent = "📂";
          tdTask.appendChild(aTask);
          tr.appendChild(tdTask);

          // 編集リンク
          const tdEdit = document.createElement("td");
          const aEdit = document.createElement("a");
          aEdit.href = `/project/edit.html?projectPublicId=${encodeURIComponent(p.publicId)}`;
          aEdit.textContent = "📝";
          tdEdit.appendChild(aEdit);
          tr.appendChild(tdEdit);

          // 削除ボタン
          const tdDelete = document.createElement("td");
          const btnDelete = document.createElement("button");
          btnDelete.className = "btn btn-link p-0 btn-delete";
          btnDelete.style.color = "red";
          btnDelete.textContent = "❌";
          tdDelete.appendChild(btnDelete);
          tr.appendChild(tdDelete);

          projectBody.appendChild(tr);

          // 削除処理
          btnDelete.addEventListener("click", async (e) => {
            if (!confirm("このプロジェクトを削除しますか？")) return;

            try {
              const token = await getCsrfToken();
              const res = await fetch(`/projects/${p.publicId}`, {
                method: "DELETE",
                headers: { "X-XSRF-TOKEN": token },
                credentials: "include",
              });

              if (res.ok) {
                tr.remove();
              } else {
                alert("削除に失敗しました");
              }
            } catch (err) {
              console.error(err);
              alert("通信エラーが発生しました");
            }
          });
        });
      }
    } catch (err) {
      console.error(err);
      alert("ページの読み込みに失敗しました");
    }
  });

  // プロジェクト登録
  const createProjectBtn = document.getElementById("create-project-btn");
  createProjectBtn.addEventListener("click", () => {
    window.location.href = `/project/create.html`;
  });
</script>
</body>
</html>
