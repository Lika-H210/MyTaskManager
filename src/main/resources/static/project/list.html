<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link href="../css/style.css" rel="stylesheet" />
  </head>

  <body class="container my-4">
    <div class="form-wrapper">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="mb-0">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§</h1>

        <div class="d-flex gap-2">
          <a href="/user/account.html" class="btn btn-outline-secondary">
            <i class="bi bi-person-circle"></i> ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
          </a>
          <button id="logout-btn" class="btn btn-outline-danger">
            <i class="bi bi-box-arrow-right"></i> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
          </button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle">
          <thead class="table-primary">
            <tr>
              <th>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</th>
              <th class="col-with-min-fixed">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
              <th class="col-with-min-fixed">ã‚¿ã‚¹ã‚¯ä¸€è¦§</th>
              <th class="col-with-min-fixed">ç·¨é›†</th>
              <th class="col-with-min-fixed">å‰Šé™¤</th>
            </tr>
          </thead>
          <tbody id="project-body">
            <!-- JSã§ãƒ‡ãƒ¼ã‚¿è¡Œã‚’æŒ¿å…¥ -->
          </tbody>
        </table>
      </div>

      <button id="create-project-btn" class="btn btn-primary">
        ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç™»éŒ²
      </button>
    </div>
    <script>
      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      document
        .getElementById("logout-btn")
        .addEventListener("click", async () => {
          if (!confirm("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;

          try {
            const res = await fetch("/logout", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" }, // Spring Securityç”¨
            });
            if (res.ok) {
              window.location.href = "/login.html"; // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå¾Œã®é·ç§»å…ˆï¼ˆä»»æ„ã«å¤‰æ›´ï¼‰
            } else {
              alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ");
            }
          } catch (err) {
            console.error(err);
            alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
          }
        });

      // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§å–å¾—
      fetch("/projects")
        .then((res) => res.json())
        .then((data) => {
          const projectBody = document.getElementById("project-body");

          if (Array.isArray(data) && data.length > 0) {
            projectBody.innerHTML = data
              .map(
                (p) => `
          <tr data-public-id="${p.publicId}">
            <td>${p.projectCaption ?? ""}</td>
            <td>${p.status ?? ""}</td>
            <td>
              <a href="/task/task-tree-list.html?projectPublicId=${p.publicId}"
                 title="ã‚¿ã‚¹ã‚¯ä¸€è¦§">
                ğŸ“‚
              </a>
            </td>
            <td>
              <a href="/project/edit.html?projectPublicId=${p.publicId}"
                 title="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°/ç·¨é›†">
                ğŸ“
              </a>
            </td>
            <td>
              <button class="btn btn-link p-0 btn-delete" title="å‰Šé™¤" style="color:red;">
                âŒ
              </button>
            </td>
          </tr>
        `
              )
              .join("");

            // å‰Šé™¤ãƒœã‚¿ãƒ³å‡¦ç†
            projectBody.querySelectorAll(".btn-delete").forEach((btn) => {
              btn.addEventListener("click", (e) => {
                const projectRow = e.target.closest("tr");
                const publicId = projectRow.dataset.publicId;
                if (confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                  fetch(`/projects/${publicId}`, { method: "DELETE" })
                    .then((res) => {
                      if (res.ok) {
                        projectRow.remove(); // è¡Œã‚’å‰Šé™¤
                      } else {
                        alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
                      }
                    })
                    .catch((err) => console.error(err));
                }
              });
            });
          } else {
            projectBody.innerHTML = `<tr><td colspan="5">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</td></tr>`;
          }
        })
        .catch((err) => {
          console.error(err);
          document.getElementById(
            "project-body"
          ).innerHTML = `<tr><td colspan="5">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>`;
        });

      // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç™»éŒ²
      const createProjectBtn = document.getElementById("create-project-btn");
      createProjectBtn.addEventListener("click", () => {
        window.location.href = `/project/create.html`;
      });
    </script>
  </body>
</html>
