<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>親子タスク一覧</title>
  <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
  />
  <link href="../css/style.css" rel="stylesheet"/>
</head>

<body class="container mt-5">
<div class="form-wrapper">
  <h2>親子タスク一覧</h2>

  <table class="table table-bordered">
    <thead class="table-primary">
    <tr>
      <th>親タスク</th>
      <th class="col-with-min-fixed">期限日</th>
      <th class="col-with-min-fixed">進捗率</th>
      <th class="col-with-min-fixed">優先度</th>
      <th class="col-with-min-fixed">子タスク</th>
      <th class="col-with-min-fixed">編集</th>
      <th class="col-with-min-fixed">削除</th>
    </tr>
    </thead>
    <tbody id="task-table-body"></tbody>
  </table>

  <button id="create-parent-task-btn" class="btn btn-primary">
    親タスク登録
  </button>
  <button type="button" class="btn btn-secondary" id="back-button">
    戻る
  </button>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const projectPublicId = params.get("projectPublicId");

  // tokenの取得
  let csrfToken = null;

  async function getCsrfToken() {
    if (csrfToken) return csrfToken; // 既に取得済みなら再利用

    try {
      const res = await fetch("/csrf-token", { credentials: "include" });
      if (!res.ok) throw new Error("CSRFトークンの取得に失敗しました");

      const data = await res.json();
      if (!data.token)
        throw new Error("CSRFトークンがレスポンスに存在しません");

      csrfToken = data.token;
      return csrfToken;
    } catch (err) {
      console.error("CSRF取得エラー:", err);
      alert("通信エラーが発生しました。操作をやり直してください。");
      throw err;
    }
  }

  async function loadTaskTrees() {
    try {
      const res = await fetch(`/projects/${projectPublicId}/task-trees`);
      if (!res.ok) throw new Error("タスク一覧の取得に失敗しました");

      const taskTrees = await res.json();
      const tbody = document.getElementById("task-table-body");
      tbody.innerHTML = "";

      taskTrees.forEach((tree) => {
        const parent = tree.parentTask;

        // 親タスク行
        const parentRow = document.createElement("tr");
        const tdCaption = document.createElement("td");
        const btnCollapse = document.createElement("button");
        btnCollapse.className = "btn btn-sm btn-outline-primary";
        btnCollapse.type = "button";
        btnCollapse.setAttribute("data-bs-toggle", "collapse");
        btnCollapse.setAttribute("data-bs-target", `#child-${parent.publicId}`);
        btnCollapse.textContent = "▼";
        tdCaption.appendChild(btnCollapse);
        tdCaption.append(" "); // ボタンとテキストの間にスペース

        const captionText = document.createTextNode(parent.taskCaption || "");
        tdCaption.appendChild(captionText);

        const tdDueDate = document.createElement("td");
        tdDueDate.textContent = parent.dueDate?.slice(5, 10) || "";

        const tdProgress = document.createElement("td");
        tdProgress.textContent = `${parent.progress || 0}%`;

        const tdPriority = document.createElement("td");
        tdPriority.textContent = parent.priority || "";

        const tdChildLink = document.createElement("td");
        const aChild = document.createElement("a");
        aChild.href = `/task/task-tree.html?projectPublicId=${encodeURIComponent(
          projectPublicId
        )}&parentTaskPublicId=${encodeURIComponent(parent.publicId)}`;
        aChild.title = "子タスク一覧";
        aChild.textContent = "📂";
        tdChildLink.appendChild(aChild);

        const tdEditLink = document.createElement("td");
        const aEdit = document.createElement("a");
        aEdit.href = `/task/edit.html?projectPublicId=${encodeURIComponent(
          projectPublicId
        )}&taskPublicId=${encodeURIComponent(parent.publicId)}&from=parent`;
        aEdit.title = "タスク詳細";
        aEdit.textContent = "📝";
        tdEditLink.appendChild(aEdit);

        const tdDelete = document.createElement("td");
        const btnDelete = document.createElement("button");
        btnDelete.className = "btn btn-link p-0 btn-delete";
        btnDelete.style.color = "red";
        btnDelete.title = "削除";
        btnDelete.textContent = "❌";
        tdDelete.appendChild(btnDelete);

        parentRow.append(tdCaption, tdDueDate, tdProgress, tdPriority, tdChildLink, tdEditLink, tdDelete);
        tbody.appendChild(parentRow);

        // 削除ボタン
        btnDelete.addEventListener("click", async () => {
          if (!confirm("このタスクを削除しますか？")) return;
          try {
            const token = await getCsrfToken();
            const delRes = await fetch(`/tasks/${parent.publicId}`, {
              method: "DELETE",
              headers: { "X-XSRF-TOKEN": token },
              credentials: "include",
            });

            if (delRes.ok) {
              await loadTaskTrees();
            } else {
              alert("削除に失敗しました");
            }
          } catch (err) {
            console.error(err);
            alert("通信エラーが発生しました");
          }
        });

        // 子タスク行
        const subtaskRow = document.createElement("tr");
        const tdSubtasks = document.createElement("td");
        tdSubtasks.colSpan = 7;
        tdSubtasks.className = "p-0";

        const collapseDiv = document.createElement("div");
        collapseDiv.className = "collapse ps-4";
        collapseDiv.id = `child-${parent.publicId}`;

        const ul = document.createElement("ul");
        ul.className = "list-unstyled m-2";

        const subtasks = tree.subtaskList || [];
        if (subtasks.length === 0) {
          const li = document.createElement("li");
          li.textContent = "---";
          ul.appendChild(li);
        } else {
          subtasks.forEach((c) => {
            const li = document.createElement("li");
            li.textContent = `${c.taskCaption}（期限:${c.dueDate?.slice(5, 10) || "-"}, 進捗:${c.progress || 0}%）`;
            ul.appendChild(li);
          });
        }

        collapseDiv.appendChild(ul);
        tdSubtasks.appendChild(collapseDiv);
        subtaskRow.appendChild(tdSubtasks);
        tbody.appendChild(subtaskRow);
      });
    } catch (err) {
      console.error(err);
      alert("タスク一覧の取得に失敗しました");
    }
  }

  document.addEventListener("DOMContentLoaded", loadTaskTrees);

  // 親タスク登録ボタン
  document
    .getElementById("create-parent-task-btn")
    .addEventListener("click", () => {
      window.location.href = `/task/create-parent.html?projectPublicId=${projectPublicId}`;
    });

  // 戻るボタン（プロジェクト一覧へ戻る）
  document.getElementById("back-button").addEventListener("click", () => {
    window.location.href = `/project/list.html`;
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
