<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>親子タスク一覧</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    />
    <link href="../css/style.css" rel="stylesheet" />
  </head>

  <body class="container mt-5">
    <div class="form-wrapper">
      <h2>親子タスク一覧</h2>

      <table class="table table-bordered">
        <thead class="table-primary">
          <tr>
            <th>親タスク</th>
            <th class="col-with-min-fixed">期限日</th>
            <th class="col-with-min-fixed">進捗率</th>
            <th class="col-with-min-fixed">優先度</th>
            <th class="col-with-min-fixed">子タスク</th>
            <th class="col-with-min-fixed">編集</th>
            <th class="col-with-min-fixed">削除</th>
          </tr>
        </thead>
        <tbody id="task-table-body"></tbody>
      </table>

      <button id="create-parent-task-btn" class="btn btn-primary">
        親タスク登録
      </button>
      <button type="button" class="btn btn-secondary" id="back-button">
        戻る
      </button>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const projectPublicId = params.get("projectPublicId");

      // tokenの取得
      let csrfToken = null;

      async function getCsrfToken() {
        if (csrfToken) return csrfToken; // 既に取得済みなら再利用

        try {
          const res = await fetch("/csrf-token", { credentials: "include" });
          if (!res.ok) throw new Error("CSRFトークンの取得に失敗しました");

          const data = await res.json();
          if (!data.token)
            throw new Error("CSRFトークンがレスポンスに存在しません");

          csrfToken = data.token;
          return csrfToken;
        } catch (err) {
          console.error("CSRF取得エラー:", err);
          alert("通信エラーが発生しました。操作をやり直してください。");
          throw err;
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        try {
          const res = await fetch(`/projects/${projectPublicId}/task-trees`);
          if (!res.ok) throw new Error("タスク一覧の取得に失敗しました");

          const taskTrees = await res.json();
          const tbody = document.getElementById("task-table-body");

          taskTrees.forEach((tree) => {
            const parent = tree.parentTask;

            // 親タスク行
            const parentRow = document.createElement("tr");
            parentRow.innerHTML = `
              <td>
                <button class="btn btn-sm btn-outline-primary"
                        type="button" data-bs-toggle="collapse"
                        data-bs-target="#child-${parent.publicId}">
                    ▼
                </button>
                ${parent.taskCaption}
              </td>
              <td>${parent.dueDate?.slice(5, 10) || ""}</td>
              <td>${parent.progress}%</td>
              <td>${parent.priority}</td>
              <td>
                <a href="/task/task-tree.html?projectPublicId=${projectPublicId}&parentTaskPublicId=${
              parent.publicId
            }"
                  title="子タスク一覧">📂</a>
              </td>
              <td>
                <a href="/task/edit.html?projectPublicId=${projectPublicId}&taskPublicId=${
              parent.publicId
            }&from=parent"
                  title="タスク詳細">📝</a>
              </td>
              <td>
                <button class="btn btn-link p-0 btn-delete" title="削除" style="color:red;">❌</button>
              </td>
            `;
            tbody.appendChild(parentRow);

            // 削除ボタン
            parentRow
              .querySelector(".btn-delete")
              .addEventListener("click", async () => {
                if (!confirm("このタスクを削除しますか？")) return;
                try {
                  const token = await getCsrfToken();
                  const delRes = await fetch(`/tasks/${parent.publicId}`, {
                    method: "DELETE",
                    headers: { "X-XSRF-TOKEN": token },
                    credentials: "include",
                  });
                  if (delRes.ok) parentRow.remove();
                  else alert("削除に失敗しました");
                } catch (err) {
                  console.error(err);
                  alert("通信エラーが発生しました");
                }
              });

            // 子タスク行
            const subtaskRow = document.createElement("tr");
            const subtasks = tree.subtaskList
              .map(
                (c) =>
                  `<li>${c.taskCaption}（期限:${
                    c.dueDate?.slice(5, 10) || "-"
                  }, 進捗:${c.progress}%）</li>`
              )
              .join("");
            subtaskRow.innerHTML = `
              <td colspan="7" class="p-0">
                <div class="collapse ps-4" id="child-${parent.publicId}">
                  <ul class="list-unstyled m-2">
                    ${subtasks || "<li>---</li>"}
                  </ul>
                </div>
              </td>
            `;
            tbody.appendChild(subtaskRow);
          });
        } catch (err) {
          console.error(err);
          alert("タスク一覧の取得に失敗しました");
        }
      });

      // 親タスク登録ボタン
      document
        .getElementById("create-parent-task-btn")
        .addEventListener("click", () => {
          window.location.href = `/task/create-parent.html?projectPublicId=${projectPublicId}`;
        });

      // 戻るボタン（プロジェクト一覧へ戻る）
      document.getElementById("back-button").addEventListener("click", () => {
        window.location.href = `/project/list.html`;
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
