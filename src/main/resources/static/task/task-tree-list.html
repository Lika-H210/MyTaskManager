<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>è¦ªå­ã‚¿ã‚¹ã‚¯ä¸€è¦§</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    />
    <link href="../css/style.css" rel="stylesheet" />
  </head>

  <body class="container mt-5">
    <div class="form-wrapper">
      <h2>è¦ªå­ã‚¿ã‚¹ã‚¯ä¸€è¦§</h2>

      <table class="table table-bordered">
        <thead class="table-primary">
          <tr>
            <th>è¦ªã‚¿ã‚¹ã‚¯</th>
            <th class="col-with-min-fixed">æœŸé™æ—¥</th>
            <th class="col-with-min-fixed">é€²æ—ç‡</th>
            <th class="col-with-min-fixed">å„ªå…ˆåº¦</th>
            <th class="col-with-min-fixed">å­ã‚¿ã‚¹ã‚¯</th>
            <th class="col-with-min-fixed">ç·¨é›†</th>
            <th class="col-with-min-fixed">å‰Šé™¤</th>
          </tr>
        </thead>
        <tbody id="task-table-body"></tbody>
      </table>

      <button id="create-parent-task-btn" class="btn btn-primary">
        è¦ªã‚¿ã‚¹ã‚¯ç™»éŒ²
      </button>
      <button type="button" class="btn btn-secondary" id="back-button">
        æˆ»ã‚‹
      </button>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const projectPublicId = params.get("projectPublicId");

      // tokenã®å–å¾—
      let csrfToken = null;

      async function getCsrfToken() {
        if (csrfToken) return csrfToken; // æ—¢ã«å–å¾—æ¸ˆã¿ãªã‚‰å†åˆ©ç”¨

        try {
          const res = await fetch("/csrf-token", { credentials: "include" });
          if (!res.ok) throw new Error("CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");

          const data = await res.json();
          if (!data.token)
            throw new Error("CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å­˜åœ¨ã—ã¾ã›ã‚“");

          csrfToken = data.token;
          return csrfToken;
        } catch (err) {
          console.error("CSRFå–å¾—ã‚¨ãƒ©ãƒ¼:", err);
          alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ“ä½œã‚’ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚");
          throw err;
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        try {
          const res = await fetch(`/projects/${projectPublicId}/task-trees`);
          if (!res.ok) throw new Error("ã‚¿ã‚¹ã‚¯ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");

          const taskTrees = await res.json();
          const tbody = document.getElementById("task-table-body");

          taskTrees.forEach((tree) => {
            const parent = tree.parentTask;

            // è¦ªã‚¿ã‚¹ã‚¯è¡Œ
            const parentRow = document.createElement("tr");
            parentRow.innerHTML = `
              <td>
                <button class="btn btn-sm btn-outline-primary"
                        type="button" data-bs-toggle="collapse"
                        data-bs-target="#child-${parent.publicId}">
                    â–¼
                </button>
                ${parent.taskCaption}
              </td>
              <td>${parent.dueDate?.slice(5, 10) || ""}</td>
              <td>${parent.progress}%</td>
              <td>${parent.priority}</td>
              <td>
                <a href="/task/task-tree.html?projectPublicId=${projectPublicId}&parentTaskPublicId=${
              parent.publicId
            }"
                  title="å­ã‚¿ã‚¹ã‚¯ä¸€è¦§">ğŸ“‚</a>
              </td>
              <td>
                <a href="/task/edit.html?projectPublicId=${projectPublicId}&taskPublicId=${
              parent.publicId
            }&from=parent"
                  title="ã‚¿ã‚¹ã‚¯è©³ç´°">ğŸ“</a>
              </td>
              <td>
                <button class="btn btn-link p-0 btn-delete" title="å‰Šé™¤" style="color:red;">âŒ</button>
              </td>
            `;
            tbody.appendChild(parentRow);

            // å‰Šé™¤ãƒœã‚¿ãƒ³
            parentRow
              .querySelector(".btn-delete")
              .addEventListener("click", async () => {
                if (!confirm("ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
                try {
                  const token = await getCsrfToken();
                  const delRes = await fetch(`/tasks/${parent.publicId}`, {
                    method: "DELETE",
                    headers: { "X-XSRF-TOKEN": token },
                    credentials: "include",
                  });
                  if (delRes.ok) parentRow.remove();
                  else alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
                } catch (err) {
                  console.error(err);
                  alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                }
              });

            // å­ã‚¿ã‚¹ã‚¯è¡Œ
            const subtaskRow = document.createElement("tr");
            const subtasks = tree.subtaskList
              .map(
                (c) =>
                  `<li>${c.taskCaption}ï¼ˆæœŸé™:${
                    c.dueDate?.slice(5, 10) || "-"
                  }, é€²æ—:${c.progress}%ï¼‰</li>`
              )
              .join("");
            subtaskRow.innerHTML = `
              <td colspan="7" class="p-0">
                <div class="collapse ps-4" id="child-${parent.publicId}">
                  <ul class="list-unstyled m-2">
                    ${subtasks || "<li>---</li>"}
                  </ul>
                </div>
              </td>
            `;
            tbody.appendChild(subtaskRow);
          });
        } catch (err) {
          console.error(err);
          alert("ã‚¿ã‚¹ã‚¯ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
      });

      // è¦ªã‚¿ã‚¹ã‚¯ç™»éŒ²ãƒœã‚¿ãƒ³
      document
        .getElementById("create-parent-task-btn")
        .addEventListener("click", () => {
          window.location.href = `/task/create-parent.html?projectPublicId=${projectPublicId}`;
        });

      // æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã¸æˆ»ã‚‹ï¼‰
      document.getElementById("back-button").addEventListener("click", () => {
        window.location.href = `/project/list.html`;
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
