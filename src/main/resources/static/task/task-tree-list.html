<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>è¦ªå­ã‚¿ã‚¹ã‚¯ä¸€è¦§</title>
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link href="../css/style.css" rel="stylesheet">
</head>

<body class="container mt-5">
<div class="form-wrapper">
  <h2>è¦ªå­ã‚¿ã‚¹ã‚¯ä¸€è¦§</h2>

  <table class="table table-bordered">
    <thead class="table-primary">
    <tr>
      <th>è¦ªã‚¿ã‚¹ã‚¯</th>
      <th class="col-with-min-fixed">æœŸé™æ—¥</th>
      <th class="col-with-min-fixed">é€²æ—ç‡</th>
      <th class="col-with-min-fixed">å„ªå…ˆåº¦</th>
      <th class="col-with-min-fixed">å­ã‚¿ã‚¹ã‚¯</th>
      <th class="col-with-min-fixed">ç·¨é›†</th>
      <th class="col-with-min-fixed">å‰Šé™¤</th>
    </tr>
    </thead>
    <tbody id="task-table-body"></tbody>
  </table>

  <button id="create-parent-task-btn" class="btn btn-primary">è¦ªã‚¿ã‚¹ã‚¯ç™»éŒ²</button>
  <button type="button" class="btn btn-secondary" id="back-button">æˆ»ã‚‹</button>

</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const projectPublicId = params.get("projectPublicId");


  fetch(`/projects/${projectPublicId}/task-trees`)
    .then(res => res.json())
    .then(taskTrees => {
      const tbody = document.getElementById("task-table-body");
      taskTrees.forEach(tree => {
        const parent = tree.parentTask;
        if (parent.isDeleted) return; // è«–ç†å‰Šé™¤ã¯è¡¨ç¤ºã—ãªã„

        // è¦ªã‚¿ã‚¹ã‚¯è¡Œ
        const parentRow = document.createElement("tr");
        const dateStr = parent.dueDate;
        const displayDate = dateStr ? dateStr.slice(5, 10) : "";
        parentRow.innerHTML = `
          <td>
            <button class="btn btn-sm btn-outline-primary"
                      type="button" data-bs-toggle="collapse"
                      data-bs-target="#child-${parent.publicId}">
                â–¼
            </button>
            ${parent.taskCaption}
          </td>
          <td>${displayDate}</td>
          <td>${parent.progress}%</td>
          <td>${parent.priority}</td>
          <td>
            <a href="/task/task-tree.html?projectPublicId=${projectPublicId}&parentTaskPublicId=${parent.publicId}"
               title="å­ã‚¿ã‚¹ã‚¯ä¸€è¦§">
              ğŸ“‚
            </a>
          </td>
          <td>
            <a href="/task/edit.html?projectPublicId=${projectPublicId}&taskPublicId=${parent.publicId}&from=parent"
               title="ã‚¿ã‚¹ã‚¯è©³ç´°">
              ğŸ“
            </a>
          </td>
          <td>
            <button class="btn btn-link p-0 btn-delete" title="å‰Šé™¤" style="color:red;">
              âŒ
            </button>
          </td>
        `;
        tbody.appendChild(parentRow);

        // å‰Šé™¤ãƒœã‚¿ãƒ³å‡¦ç†
        parentRow.querySelector(".btn-delete").addEventListener("click", () => {
          if (confirm("ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            fetch(`/tasks/${parent.publicId}`, { method: "DELETE" })
              .then(res => {
                if (!res.ok) throw new Error("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
                parentRow.remove(); // ç”»é¢ã‹ã‚‰å‰Šé™¤
              })
              .catch(err => alert(err.message));
          }
        });

        // å­ã‚¿ã‚¹ã‚¯è¡Œï¼ˆcollapseã§éš ã™ï¼‰
        const subtaskRow = document.createElement("tr");
        const subtasks = tree.subtaskList
          .filter(c => !c.isDeleted)
          .map(c => {
            const due = c.dueDate ? c.dueDate.slice(5, 10) : ""; // "MM-DD" ã ã‘å–å¾—
            return `
              <li>
                ${c.taskCaption}ï¼ˆæœŸé™: ${due}, é€²æ—: ${c.progress}%ï¼‰
              </li>
            `;
          }).join("");

        subtaskRow.innerHTML = `
          <td colspan="7" class="p-0">
            <div class="collapse ps-7" id="child-${parent.publicId}">
              <ul class="list-unstyled m-2">
                ${subtasks || "<li>---</li>"}
              </ul>
            </div>
          </td>
        `;
        tbody.appendChild(subtaskRow);
      });
    })
    .catch(err => console.error("Error loading tasks:", err));

  // è¦ªã‚¿ã‚¹ã‚¯ç™»éŒ²ãƒœã‚¿ãƒ³
  document.getElementById('create-parent-task-btn').addEventListener('click', () => {
    window.location.href = `/task/create-parent.html?projectPublicId=${projectPublicId}`;
  });

  // æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã¸æˆ»ã‚‹ï¼‰
  document.getElementById('back-button').addEventListener('click', () => {
    window.location.href = `/project/list.html`;
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>