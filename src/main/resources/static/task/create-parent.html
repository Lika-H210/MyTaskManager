<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>親タスク登録</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet">
  <link href="../css/style.css" rel="stylesheet">
</head>

<body class="container my-4">
<div class="form-wrapper">
  <h3 class="mb-3">親タスク登録</h3>
  <form id="parent-task-form">

    <div class="mb-3">
      <label for="task-caption" class="form-label">
        タスク名<span class="required">必須</span>
      </label>
      <input type="text" class="form-control full-width-input" id="task-caption" name="taskCaption"
             required maxlength="100" pattern=".*\S.*">
    </div>

    <div class="mb-3">
      <label for="description" class="form-label">詳細説明</label>
      <textarea class="form-control full-width-input" id="description" name="description"
                rows="3" maxlength="1000"></textarea>
    </div>

    <div class="mb-3">
      <label for="due-date" class="form-label">
        期限日<span class="required">必須</span>
      </label>
      <input type="date" class="form-control short-input" id="due-date" name="dueDate" required>
    </div>

    <div class="mb-3">
      <label for="estimated-time" class="form-label">
        見積時間（分）<span class="required">必須</span>
      </label>
      <input type="number" class="form-control short-input" id="estimated-time" name="estimatedTime"
             required min="1">
    </div>

    <div class="mb-3">
      <label for="priority" class="form-label">優先度</label>
      <select class="form-select short-input" id="priority" name="priority" required>
        <option value="LOW" selected>LOW</option>
        <option value="MEDIUM">MEDIUM</option>
        <option value="HIGH">HIGH</option>
      </select>
    </div>

    <button type="submit" class="btn btn-success">登録</button>
    <button type="button" class="btn btn-secondary" id="back-button">戻る</button>

  </form>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const projectPublicId = params.get('projectPublicId');

  document.getElementById('parent-task-form').addEventListener('submit', (e) => {
    e.preventDefault();

    const requestBody = {
      taskCaption: document.getElementById('task-caption').value,
      description: document.getElementById('description').value || "", // null → ""
      dueDate: document.getElementById('due-date').value,
      estimatedTime: parseInt(document.getElementById('estimated-time').value, 10),
      actualTime: 0,   // デフォルト
      progress: 0,     // デフォルト
      priority: document.getElementById('priority').value || "LOW" // 未選択はLOW
    };


    fetch(`/projects/${projectPublicId}/tasks`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(requestBody)
    })
      .then(res => {
        if (res.ok) {
          // 登録成功 → 親子タスク一覧画面に戻る
          window.location.href = `/task/task-tree-list.html?projectPublicId=${projectPublicId}`;
        } else {
          return res.json().then(err => { throw err; });
        }
      })
      .catch(err => {
        alert('登録に失敗しました: ' + (err.message || JSON.stringify(err)));
        console.error(err);
      });
  });

  // 戻るボタン（親子タスク一覧画面へ戻る）
  document.getElementById('back-button').addEventListener('click', () => {
    window.location.href = `/task/task-tree-list.html?projectPublicId=${projectPublicId}`;
  });
</script>
</body>
</html>