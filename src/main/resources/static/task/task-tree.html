<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>親子タスク</title>
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link href="../css/style.css" rel="stylesheet">
</head>

<body class="container mt-5">
<div class="form-wrapper">
  <h2 id="parent-task-name">親子タスク</h2>

  <div class="mb-3 p-3 border rounded bg-light">
    <strong id="parent-task-caption">親タスク: </strong><br>
    <span id="parent-task-due-date">期限: </span><br>
    <span id="parent-task-progress">達成度: </span>
  </div>

  <table class="table table-bordered">
    <thead class="table-primary">
    <tr>
      <th>タスク</th>
      <th class="col-with-min-fixed">期限日</th>
      <th class="col-with-min-fixed">進捗率</th>
      <th class="col-with-min-fixed">優先度</th>
      <th class="col-with-min-fixed">編集</th>
      <th class="col-with-min-fixed">削除</th>
    </tr>
    </thead>
    <tbody id="subtask-body"></tbody>
  </table>

  <button id="create-subtask-btn" class="btn btn-primary">子タスク登録</button>
  <button type="button" class="btn btn-secondary" id="back-button">戻る</button>

</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const projectPublicId = params.get("projectPublicId");
  const parentTaskPublicId = params.get("parentTaskPublicId");

  fetch(`/task-trees/${parentTaskPublicId}`)
    .then(res => res.json())
    .then(taskTree => {
      const parent = taskTree.parentTask;

      // 親タスク情報を上部に文字列表示
      document.getElementById("parent-task-caption").textContent = "親タスク名: " + parent.taskCaption;
      document.getElementById("parent-task-due-date").textContent = "期限: " + (parent.dueDate || "-");
      document.getElementById("parent-task-progress").textContent = "達成度: " + parent.progress + "%";

      // 子タスクをテーブルに描画
      const subtaskBody = document.getElementById("subtask-body");
      taskTree.subtaskList?.filter(c => !c.isDeleted).forEach(c => {
        const due = c.dueDate ? c.dueDate.slice(5, 10) : ""; // "MM-DD"
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${c.taskCaption}</td>
          <td>${due}</td>
          <td>${c.progress}%</td>
          <td>${c.priority}</td>
          <td>
            <a href="/task/edit.html?projectPublicId=${projectPublicId}&parentTaskPublicId=${parentTaskPublicId}&taskPublicId=${c.publicId}&from=child"
               title="プロジェクト詳細">
              📝
            </a>
          </td>
          <td>
            <button class="btn btn-link p-0 btn-delete" title="削除" style="color:red;">
              ❌
            </button>
          </td>
        `;
        subtaskBody.appendChild(row);

        // 削除ボタン
        row.querySelector(".btn-delete").addEventListener("click", () => {
          if (confirm("このタスクを削除しますか？")) {
            fetch(`/tasks/${c.publicId}`, { method: "DELETE" })
              .then(res => {
                if (!res.ok) throw new Error("削除に失敗しました");
                row.remove();
              })
              .catch(err => alert(err.message));
          }
        });
      });
    })
  .catch(err => console.error("Error loading taskTree:", err));

  // 子タスク登録ボタン
  document.getElementById('create-subtask-btn').addEventListener('click', () => {
    window.location.href = `/task/create-subtask.html?projectPublicId=${projectPublicId}&parentTaskPublicId=${parentTaskPublicId}`;
  });

  // 戻るボタン（親子タスク一覧へ戻る）
  document.getElementById('back-button').addEventListener('click', () => {
    window.location.href = `/task/task-tree-list.html?projectPublicId=${projectPublicId}`;
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>