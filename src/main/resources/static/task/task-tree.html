<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>è¦ªå­ã‚¿ã‚¹ã‚¯</title>
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link href="../css/style.css" rel="stylesheet">
</head>

<body class="container mt-5">
<div class="form-wrapper">
  <h2 id="parent-task-name">è¦ªå­ã‚¿ã‚¹ã‚¯</h2>

  <div class="mb-3 p-3 border rounded bg-light">
    <strong id="parent-task-caption">è¦ªã‚¿ã‚¹ã‚¯: </strong><br>
    <span id="parent-task-due-date">æœŸé™: </span><br>
    <span id="parent-task-progress">é”æˆåº¦: </span>
  </div>

  <table class="table table-bordered">
    <thead class="table-primary">
    <tr>
      <th>ã‚¿ã‚¹ã‚¯</th>
      <th class="col-with-min-fixed">æœŸé™æ—¥</th>
      <th class="col-with-min-fixed">é€²æ—ç‡</th>
      <th class="col-with-min-fixed">å„ªå…ˆåº¦</th>
      <th class="col-with-min-fixed">ç·¨é›†</th>
      <th class="col-with-min-fixed">å‰Šé™¤</th>
    </tr>
    </thead>
    <tbody id="subtask-body"></tbody>
  </table>

  <button id="create-subtask-btn" class="btn btn-primary">å­ã‚¿ã‚¹ã‚¯ç™»éŒ²</button>
  <button type="button" class="btn btn-secondary" id="back-button">æˆ»ã‚‹</button>

</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const projectPublicId = params.get("projectPublicId");
  const parentTaskPublicId = params.get("parentTaskPublicId");

  fetch(`/task-trees/${parentTaskPublicId}`)
    .then(res => res.json())
    .then(taskTree => {
      const parent = taskTree.parentTask;

      // è¦ªã‚¿ã‚¹ã‚¯æƒ…å ±ã‚’ä¸Šéƒ¨ã«æ–‡å­—åˆ—è¡¨ç¤º
      document.getElementById("parent-task-caption").textContent = "è¦ªã‚¿ã‚¹ã‚¯å: " + parent.taskCaption;
      document.getElementById("parent-task-due-date").textContent = "æœŸé™: " + (parent.dueDate || "-");
      document.getElementById("parent-task-progress").textContent = "é”æˆåº¦: " + parent.progress + "%";

      // å­ã‚¿ã‚¹ã‚¯ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«æç”»
      const subtaskBody = document.getElementById("subtask-body");
      taskTree.subtaskList?.filter(c => !c.isDeleted).forEach(c => {
        const due = c.dueDate ? c.dueDate.slice(5, 10) : ""; // "MM-DD"
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${c.taskCaption}</td>
          <td>${due}</td>
          <td>${c.progress}%</td>
          <td>${c.priority}</td>
          <td>
            <a href="/task/edit.html?projectPublicId=${projectPublicId}&parentTaskPublicId=${parentTaskPublicId}&taskPublicId=${c.publicId}&from=child"
               title="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°">
              ğŸ“
            </a>
          </td>
          <td>
            <button class="btn btn-link p-0 btn-delete" title="å‰Šé™¤" style="color:red;">
              âŒ
            </button>
          </td>
        `;
        subtaskBody.appendChild(row);

        // å‰Šé™¤ãƒœã‚¿ãƒ³
        row.querySelector(".btn-delete").addEventListener("click", () => {
          if (confirm("ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            fetch(`/tasks/${c.publicId}`, { method: "DELETE" })
              .then(res => {
                if (!res.ok) throw new Error("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
                row.remove();
              })
              .catch(err => alert(err.message));
          }
        });
      });
    })
  .catch(err => console.error("Error loading taskTree:", err));

  // å­ã‚¿ã‚¹ã‚¯ç™»éŒ²ãƒœã‚¿ãƒ³
  document.getElementById('create-subtask-btn').addEventListener('click', () => {
    window.location.href = `/task/create-subtask.html?projectPublicId=${projectPublicId}&parentTaskPublicId=${parentTaskPublicId}`;
  });

  // æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆè¦ªå­ã‚¿ã‚¹ã‚¯ä¸€è¦§ã¸æˆ»ã‚‹ï¼‰
  document.getElementById('back-button').addEventListener('click', () => {
    window.location.href = `/task/task-tree-list.html?projectPublicId=${projectPublicId}`;
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>