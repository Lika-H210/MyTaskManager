<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>è¦ªå­ã‚¿ã‚¹ã‚¯</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    />
    <link href="../css/style.css" rel="stylesheet" />
  </head>

  <body class="container mt-5">
    <div class="form-wrapper">
      <h2 id="parent-task-name">è¦ªå­ã‚¿ã‚¹ã‚¯</h2>

      <div class="mb-3 p-3 border rounded bg-light">
        <strong id="parent-task-caption">è¦ªã‚¿ã‚¹ã‚¯: </strong><br />
        <span id="parent-task-due-date">æœŸé™: </span><br />
        <span id="parent-task-progress">é”æˆåº¦: </span>
      </div>

      <table class="table table-bordered">
        <thead class="table-primary">
          <tr>
            <th>ã‚¿ã‚¹ã‚¯</th>
            <th class="col-with-min-fixed">æœŸé™æ—¥</th>
            <th class="col-with-min-fixed">é€²æ—ç‡</th>
            <th class="col-with-min-fixed">å„ªå…ˆåº¦</th>
            <th class="col-with-min-fixed">ç·¨é›†</th>
            <th class="col-with-min-fixed">å‰Šé™¤</th>
          </tr>
        </thead>
        <tbody id="subtask-body"></tbody>
      </table>

      <button id="create-subtask-btn" class="btn btn-primary">
        å­ã‚¿ã‚¹ã‚¯ç™»éŒ²
      </button>
      <button type="button" class="btn btn-secondary" id="back-button">
        æˆ»ã‚‹
      </button>
    </div>

    <script>
      const params = new URLSearchParams(window.location.search);
      const projectPublicId = params.get("projectPublicId");
      const parentTaskPublicId = params.get("parentTaskPublicId");

      // tokenã®å–å¾—
      let csrfToken = null;

      async function getCsrfToken() {
        if (csrfToken) return csrfToken; // æ—¢ã«å–å¾—æ¸ˆã¿ãªã‚‰å†åˆ©ç”¨

        try {
          const res = await fetch("/csrf-token", { credentials: "include" });
          if (!res.ok) throw new Error("CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");

          const data = await res.json();
          if (!data.token)
            throw new Error("CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å­˜åœ¨ã—ã¾ã›ã‚“");

          csrfToken = data.token;
          return csrfToken;
        } catch (err) {
          console.error("CSRFå–å¾—ã‚¨ãƒ©ãƒ¼:", err);
          alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ“ä½œã‚’ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚");
          throw err; // å‘¼ã³å‡ºã—å…ƒã§ã‚‚ try/catch ã§å‡¦ç†å¯èƒ½
        }
      }

      document.addEventListener("DOMContentLoaded", async () => {
        try {
          const res = await fetch(`/task-trees/${parentTaskPublicId}`);
          if (!res.ok) throw new Error("ã‚¿ã‚¹ã‚¯ãƒ„ãƒªãƒ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");

          const taskTree = await res.json();
          const parent = taskTree.parentTask;

          // è¦ªã‚¿ã‚¹ã‚¯æƒ…å ±ã‚’ä¸Šéƒ¨ã«è¡¨ç¤º
          document.getElementById("parent-task-caption").textContent =
            "è¦ªã‚¿ã‚¹ã‚¯å: " + parent.taskCaption;
          document.getElementById("parent-task-due-date").textContent =
            "æœŸé™: " + (parent.dueDate || "-");
          document.getElementById("parent-task-progress").textContent =
            "é”æˆåº¦: " + parent.progress + "%";

          // å­ã‚¿ã‚¹ã‚¯ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«æç”»
          const subtaskBody = document.getElementById("subtask-body");
          taskTree.subtaskList?.forEach((c) => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${c.taskCaption}</td>
              <td>${c.dueDate?.slice(5, 10) || ""}</td>
              <td>${c.progress}%</td>
              <td>${c.priority}</td>
              <td>
                <a href="/task/edit.html?projectPublicId=${projectPublicId}&parentTaskPublicId=${parentTaskPublicId}&taskPublicId=${
              c.publicId
            }&from=child"
                  title="ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°">
                  ğŸ“
                </a>
              </td>
              <td>
                <button class="btn btn-link p-0 btn-delete" title="å‰Šé™¤" style="color:red;">âŒ</button>
              </td>
            `;
            subtaskBody.appendChild(row);

            // å‰Šé™¤ãƒœã‚¿ãƒ³
            row
              .querySelector(".btn-delete")
              .addEventListener("click", async () => {
                if (!confirm("ã“ã®ã‚¿ã‚¹ã‚¯ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

                try {
                  const token = await getCsrfToken();
                  const res = await fetch(`/tasks/${c.publicId}`, {
                    method: "DELETE",
                    headers: { "X-XSRF-TOKEN": token },
                    credentials: "include",
                  });

                  if (res.ok) {
                    row.remove();
                  } else {
                    alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
                  }
                } catch (err) {
                  console.error(err);
                  alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                }
              });
          });
        } catch (err) {
          console.error(err);
          alert("ã‚¿ã‚¹ã‚¯ãƒ„ãƒªãƒ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
      });

      // å­ã‚¿ã‚¹ã‚¯ç™»éŒ²ãƒœã‚¿ãƒ³
      document
        .getElementById("create-subtask-btn")
        .addEventListener("click", () => {
          window.location.href = `/task/create-subtask.html?projectPublicId=${projectPublicId}&parentTaskPublicId=${parentTaskPublicId}`;
        });

      // æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆè¦ªå­ã‚¿ã‚¹ã‚¯ä¸€è¦§ã¸æˆ»ã‚‹ï¼‰
      document.getElementById("back-button").addEventListener("click", () => {
        window.location.href = `/task/task-tree-list.html?projectPublicId=${projectPublicId}`;
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
